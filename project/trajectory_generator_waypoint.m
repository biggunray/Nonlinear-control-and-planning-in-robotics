function [ desired_state ] = trajectory_generator_waypoint(t,path)
% this trajectory_generator method uses waypoint method to find convert the
% path from Dijkstra to flat outputs

% input---
% path: 3xn matrix generated by Dijkstra
% output---
% desired_state: flat output 


n = size(path,2); % number of waypoints
speed = 2; % speed of the hover, can be tuned

time = 0;
dist = zeros(1,n);
velocityVec = zeros(3,n);
direction = zeros(3,n);
timeVector = zeros(1,n);

pos = [0;0;0];
vel = [0;0;0];
acc = [0;0;0];

if n>1 
    for i = 2:n
        dist(i) = norm(path(:,i) - path(:,i-1));
        direction(:,i) = (path(:,i) - path(:,i-1))/dist(i);
        velocityVec(:,i) = speed* direction(:,i);
        time = time + dist(i)/speed;
        timeVector(i) = time;
    end 
    
    if t> timeVector(end) 
        pos = path(:,end);
    elseif t == 0
        pos = path(:,1);
    else
        for i = 1:n
            if t <= timeVector(i)
                pos = path(:,i);
                vel = velocityVec(:,i);
            end
        end
    end
else
    pos = path(:,1);
end

yaw = 0;
yawdot = 0;

desired_state.pos = pos(:);
desired_state.vel = vel(:);
desired_state.acc = acc(:);
desired_state.yaw = yaw;
desired_state.yawdot = yawdot;
